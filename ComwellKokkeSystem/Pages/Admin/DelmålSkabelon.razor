@page "/delmaalskabeloner"
@inject IDelmaalSkabelonService DelmaalSkabelonService
@inject IUnderdelmaalSkabelonService UnderdelmaalSkabelonService
@using Modeller
@using System.Linq

<link href="css/Delmaal.css" rel="stylesheet" />


<h3>🧾 Elevplanskabelon</h3>

@if (skabeloner == null)
{
    <p>Indlæser skabeloner...</p>
}
else
{
    @for (int periode = 1; periode <= 3; periode++)
    {
        var periodeSkabeloner = skabeloner.Where(s => s.PraktikperiodeNummer == periode).ToList();

        if (periodeSkabeloner.Any())
        {
            <div class="border rounded p-3 mb-4 shadow-sm bg-light">
                <h4 class="mb-3">📌 Praktikperiode @periode</h4>
                <table class="table table-striped mb-0">
                    <thead>
                        <tr>
                            <th class="beskrivelse-col">Beskrivelse</th>
                            <th class="underdelmaal-col text-center">Underdelmål</th>
                            <th class="handlinger-col text-end">Handlinger</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var s in periodeSkabeloner)
                        {
                            <tr>
                                <td class="beskrivelse-col">@s.Beskrivelse</td>
                                <td class="underdelmaal-col">
                                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => ToggleUnderdelmaalVisning(s.Id)">
                                        @(udvidetDelmaalId == s.Id ? "⬆️ Skjul" : "⬇️ Vis")
                                    </button>
                                </td>
                                <td class="handlinger-col">
                                    <button class="btn btn-sm btn-warning me-1" @onclick="() => RedigerSkabelon(s)">✏️</button>
                                    <button class="btn btn-sm btn-danger me-1" @onclick="() => SletSkabelon(s.Id)">🗑️</button>
                                    <button class="btn btn-sm btn-success" @onclick="() => ÅbenUnderdelmaalModal(s.Id)">➕ Underdelmål</button>
                                </td>
                            </tr>
                            @if (udvidetDelmaalId == s.Id)
                            {
                                var relevanteUnderdelmaal = underdelmaalListe.Where(u => u.DelmaalSkabelonId == s.Id).ToList();
                                if (relevanteUnderdelmaal.Any())
                                {
                                    <tr>
                                        <td colspan="3">
                                            <ul class="list-group list-group-flush">
                                                @foreach (var u in relevanteUnderdelmaal)
                                                {
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <strong>@u.Beskrivelse</strong><br />
                                                            <small c
                                                                lass="text-muted">🗓 Deadline-dage: @u.Deadline</small>
                                                        </div>
                                                        <div>
                                                            <button class="btn btn-sm btn-warning me-1" @onclick="() => RedigerUnderdelmaal(u)">✏️</button>
                                                            <button class="btn btn-sm btn-danger" @onclick="() => SletUnderdelmaal(u.Id, s.Id)">🗑️</button>
                                                        </div>
                                                    </li>
                                                }
                                            </ul>
                                        </td>
                                    </tr>
                                }
                            }
                        }
                    </tbody>
                </table>

            </div>
        }
    }
}

<!-- Tilføj delmål-knap -->
<button class="btn btn-primary mb-4" @onclick="ÅbenTilføjModal">➕ Tilføj delmål</button>

<!-- Modal: Tilføj/rediger delmålsskabelon -->
<div class="modal fade @(visModal ? "show d-block" : "")" tabindex="-1" style="background-color: rgba(0,0,0,0.5);" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">@((redigerMode ? "Rediger delmålsskabelon" : "Tilføj ny delmålsskabelon"))</h5>
                <button type="button" class="btn-close" @onclick="LukModal"></button>
            </div>
            <div class="modal-body">
                <EditForm Model="nySkabelon" OnValidSubmit="GemSkabelon">
                    <DataAnnotationsValidator />
                    <ValidationSummary />
                    <InputNumber class="form-control mb-2" @bind-Value="nySkabelon.PraktikperiodeNummer" />
                    <InputText class="form-control mb-2" @bind-Value="nySkabelon.Beskrivelse" />
                   
                    <InputText class="form-control mb-2" @bind-Value="nySkabelon.Ansvarlig" />
                    <InputText class="form-control mb-2" @bind-Value="nySkabelon.Igangsætter" />
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">@((redigerMode) ? "Opdater" : "Tilføj")</button>
                        <button type="button" class="btn btn-secondary" @onclick="LukModal">Annuller</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Tilføj/rediger underdelmålsskabelon -->
<div class="modal fade @(visUnderdelmaalModal ? "show d-block" : "")" tabindex="-1" style="background-color: rgba(0,0,0,0.5);" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Tilføj underdelmål til delmål @valgtDelmaalSkabelonId</h5>
                <button type="button" class="btn-close" @onclick="LukUnderdelmaalModal"></button>
            </div>
            <div class="modal-body">
                <EditForm Model="nyUnderdelmaal" OnValidSubmit="GemUnderdelmaalSkabelon">
                    <DataAnnotationsValidator />
                    <ValidationSummary />
                    <InputText class="form-control mb-2" @bind-Value="nyUnderdelmaal.Beskrivelse" />
                    <label for="deadlineInput">Deadline</label>
                    <InputDate id="deadlineInput" class="form-control mb-2" @bind-Value="nyUnderdelmaal.Deadline" />

                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">@((redigererUnderdelmaal) ? "Opdater" : "Tilføj")</button>
                        <button type="button" class="btn btn-secondary" @onclick="LukUnderdelmaalModal">Annuller</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
</div>

@code {
    private List<DelmaalSkabelon>? skabeloner;
    private DelmaalSkabelon nySkabelon = new();
    private bool redigerMode = false;
    private bool visModal = false;
    private bool visUnderdelmaalModal = false;
    private int valgtDelmaalSkabelonId;
    private UnderdelmaalSkabelon nyUnderdelmaal = new();
    private int? udvidetDelmaalId = null;
    private List<UnderdelmaalSkabelon> underdelmaalListe = new();
    private bool redigererUnderdelmaal = false;

    protected override async Task OnInitializedAsync()
    {
        skabeloner = await DelmaalSkabelonService.GetAllAsync();
    }

    private async Task GemSkabelon()
    {
        if (redigerMode)
            await DelmaalSkabelonService.UpdateAsync(nySkabelon);
        else
            await DelmaalSkabelonService.AddAsync(nySkabelon);

        visModal = false;
        redigerMode = false;
        nySkabelon = new();
        skabeloner = await DelmaalSkabelonService.GetAllAsync();
    }

    private void RedigerSkabelon(DelmaalSkabelon s)
    {
        nySkabelon = new DelmaalSkabelon
            {
                Id = s.Id,
                PraktikperiodeNummer = s.PraktikperiodeNummer,
                Beskrivelse = s.Beskrivelse,
               
                Ansvarlig = s.Ansvarlig,
                Igangsætter = s.Igangsætter
            };
        redigerMode = true;
        visModal = true;
    }


    private async Task SletSkabelon(int id)
    {
        await DelmaalSkabelonService.DeleteAsync(id);
        skabeloner = await DelmaalSkabelonService.GetAllAsync();
    }

    private void ÅbenTilføjModal() => (nySkabelon, visModal, redigerMode) = (new(), true, false);
    private void LukModal() => (visModal, redigerMode, nySkabelon) = (false, false, new());

    private void ÅbenUnderdelmaalModal(int delmaalSkabelonId)
    {
        valgtDelmaalSkabelonId = delmaalSkabelonId;
        nyUnderdelmaal = new UnderdelmaalSkabelon { DelmaalSkabelonId = delmaalSkabelonId };
        redigererUnderdelmaal = false;
        visUnderdelmaalModal = true;
    }

    private void RedigerUnderdelmaal(UnderdelmaalSkabelon u)
    {
        nyUnderdelmaal = new UnderdelmaalSkabelon
            {
                Id = u.Id,
                DelmaalSkabelonId = u.DelmaalSkabelonId,
                Beskrivelse = u.Beskrivelse,
                Deadline = u.Deadline
            };
        valgtDelmaalSkabelonId = u.DelmaalSkabelonId;
        redigererUnderdelmaal = true;
        visUnderdelmaalModal = true;
    }


    private void LukUnderdelmaalModal() => (visUnderdelmaalModal, nyUnderdelmaal) = (false, new());

    private async Task GemUnderdelmaalSkabelon()
    {
        if (redigererUnderdelmaal)
            await UnderdelmaalSkabelonService.UpdateAsync(nyUnderdelmaal);
        else
            await UnderdelmaalSkabelonService.AddAsync(nyUnderdelmaal);

        visUnderdelmaalModal = false;

        underdelmaalListe.RemoveAll(u => u.DelmaalSkabelonId == valgtDelmaalSkabelonId);
        await ToggleUnderdelmaalVisning(valgtDelmaalSkabelonId);
    }


    private async Task ToggleUnderdelmaalVisning(int delmaalSkabelonId)
    {
        if (udvidetDelmaalId == delmaalSkabelonId)
        {
            udvidetDelmaalId = null;
        }
        else
        {
            udvidetDelmaalId = delmaalSkabelonId;

            if (!underdelmaalListe.Any(u => u.DelmaalSkabelonId == delmaalSkabelonId))
            {
                var result = await UnderdelmaalSkabelonService.GetByDelmaalSkabelonIdAsync(delmaalSkabelonId);
                underdelmaalListe.AddRange(result);
            }
        }
    }


    private async Task SletUnderdelmaal(int id, int delmaalSkabelonId)
    {
        await UnderdelmaalSkabelonService.DeleteAsync(id);
        underdelmaalListe.RemoveAll(u => u.Id == id);
        await ToggleUnderdelmaalVisning(delmaalSkabelonId);
    }

}
