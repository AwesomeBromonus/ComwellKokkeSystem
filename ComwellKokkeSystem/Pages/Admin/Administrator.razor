@page "/administrator"
@inject HttpClient Http
@inject NavigationManager NavManager
@inject UserState UserState
@using Modeller

<link href="css/Panel.css" rel="stylesheet" />

<div class="admin-container">
    @if (!UserState.IsLoggedInChecked)
    {
        <p class="loading-text">⏳ Indlæser brugerstatus...</p>
    }
    else if (!UserState.IsLoggedIn)
    {
        <div class="alert alert-warning">🔒 Du skal være logget ind for at se denne side.</div>
    }
    else if (UserState.Role?.ToLower() != "admin")
    {
        <div class="alert alert-danger">🚫 Adgang nægtet – kun administratorer har adgang.</div>
    }
    else
    {
        <!-- 🔝 Top -->
        <div class="admin-header">
            <div class="admin-header-top">
                <h2>🛠 Administratorpanel – velkommen, <span class="username">@UserState.Username</span>!</h2>
            </div>
        </div>

        <!-- 🚀 Dashboard-kort -->
        <div class="dashboard-cards">
            <div class="dashboard-card" @onclick="@(() => NavManager.NavigateTo("/opretuser"))">
                <div class="icon">👤</div>
                <h4>Opret bruger</h4>
                <p>Tilføj ny systembruger</p>
            </div>
            <div class="dashboard-card" @onclick="@(() => NavManager.NavigateTo("/opret-elevplan"))">
                <div class="icon">📋</div>
                <h4>Opret elevplan</h4>
                <p>Opret og tildel elevplan</p>
            </div>
            <div class="dashboard-card highlight" @onclick="@(() => NavManager.NavigateTo("/anmodninger"))">
                <div class="icon">📥</div>
                <h4>Anmodninger</h4>
                <p><strong>@anmodningerAntal</strong> afventer godkendelse</p>
            </div>
        </div>

        <!-- 🔍 Filter -->
        <div class="search-section">
            <input class="search-input" placeholder="🔍 Søg brugernavn..." @bind="søgeord" />
            <select class="role-filter" @bind="valgtRolle">
                <option value="">Alle roller</option>
                <option value="elev">Elev</option>
                <option value="admin">Administrator</option>
                <option value="kok">Kok</option>
                <option value="hr">HR</option>
            </select>
        </div>

        <!-- 👤 Brugerliste -->
        <div class="user-grid">
            @foreach (var b in brugere.Where(b =>
           (string.IsNullOrWhiteSpace(søgeord) || b.Username.Contains(søgeord, StringComparison.OrdinalIgnoreCase)) &&
           (string.IsNullOrWhiteSpace(valgtRolle) || b.Role?.ToLower() == valgtRolle)))
            {
                <div class="user-card" @onclick="@(() => VisDetaljer(b))">
                    <img src="@GetImageUrl(b.Id)"
                        
                         class="user-image rounded-circle mb-2" width="64" height="64" alt="Profil" />
                    <h5>@b.Navn</h5>
                    <p>@b.Username</p>
                    <span class="role-tag @GetRoleClass(b.Role)">@b.Role</span>
                </div>
            }
        </div>

        <!-- 🧾 Modal -->
        @if (valgtBruger is not null)
        {
            <div class="modal-backdrop">
                <div class="modal-window">
                    <div class="modal-header">
                        <h5><i class="fa fa-user me-2"></i> Brugerinfo: @valgtBruger.Navn</h5>
                        <button class="btn-close" @onclick="LukDetaljer">×</button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Navn:</strong> @valgtBruger.Navn</p>
                        <p><strong>Email:</strong> @valgtBruger.Email</p>
                        <p><strong>Telefon:</strong> @valgtBruger.Tlf</p>
                        <p><strong>Adresse:</strong> @valgtBruger.Adresse</p>
                        <p><strong>Hotel:</strong> @valgtBruger.HotelNavn</p>
                        <p><strong>Startdato:</strong> @valgtBruger.StartDato.ToShortDateString()</p>
                        <p><strong>Slutdato:</strong> @valgtBruger.SlutDato?.ToShortDateString()</p>
                        <p><strong>Skoleperiode:</strong> @HentSkoleperiode(valgtBruger)</p>
                        <p><strong>Skoleforløb:</strong> @HentSkoleforloeb(valgtBruger)</p>
                        <p><strong>Rolle:</strong> <span class="role-tag @GetRoleClass(valgtBruger.Role)">@valgtBruger.Role</span></p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @onclick="LukDetaljer">Luk</button>
                        <button class="btn btn-danger" @onclick="SletBrugerAsync">Slet</button>
                        @if (valgtBruger.Role?.ToLower() == "elev" && valgtBruger.ElevplanId > 0)
                        {
                            <button class="btn btn-info" @onclick="@(() => SeElevplan(valgtBruger.ElevplanId.Value))">Se elevplan</button>
                        }
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    private List<UserModel> brugere = new();
    private UserModel? valgtBruger;
    private string søgeord = "";
    private string valgtRolle = "";
    private int anmodningerAntal = 0;
    private Dictionary<int, Elevplan> elevplaner = new(); // key = ElevplanId


    // Denne metode kaldes automatisk, når komponenten initialiseres
    protected override async Task OnInitializedAsync()
    {
        // 🔄 Hent alle brugere fra API'et og gem dem i 'brugere'-listen
        await LoadUsers();

        // 📬 Hent og tæl antallet af anmodninger med status "afventer"
        await HentAntalAnmodninger();

        // 🎓 Gennemgå alle brugere der er elever og har en tilknyttet elevplan
        foreach (var elev in brugere.Where(b => b.Role?.ToLower() == "elev" && b.ElevplanId.HasValue))
        {
            try
            {
                // 📦 Hent elevens elevplan fra API'et via ID
                var plan = await Http.GetFromJsonAsync<Elevplan>($"api/elevplan/{elev.ElevplanId.Value}");

                // ✅ Hvis elevplanen blev hentet korrekt, tilføj den til ordbogen 'elevplaner'
                if (plan != null)
                {
                    elevplaner[elev.ElevplanId.Value] = plan;
                }
            }
            catch
            {
                // ⚠ Hvis noget går galt, log fejlbesked til konsollen
                Console.WriteLine($"Kunne ikke hente elevplan for elev {elev.Username}");
            }
        }
    }


    private async Task LoadUsers()
    {
        try
        {
            // 🔄 Hent alle brugere fra API'et som en liste af UserModel
            var users = await Http.GetFromJsonAsync<List<UserModel>>("api/users/all");

            // ✅ Hvis der faktisk kom brugere tilbage, gem dem i brugere-listen
            if (users is not null)
                brugere = users;
        }
        catch (Exception ex)
        {
            // ⚠ Hvis noget går galt, log fejlen til konsollen
            Console.WriteLine("Fejl ved indlæsning af brugere: " + ex.Message);
        }
    }

    private async Task HentAntalAnmodninger()
    {
        try
        {
            // 🔄 Hent alle anmodninger fra API'et
            var liste = await Http.GetFromJsonAsync<List<Anmodning>>("api/anmodning");

            // ✅ Hvis listen ikke er null, tæl hvor mange har status "afventer"
            if (liste != null)
                anmodningerAntal = liste.Count(a => a.Status?.ToLower() == "afventer");
        }
        catch
        {
            // ⚠ Hvis noget går galt, sæt antallet til 0
            anmodningerAntal = 0;
        }
    }


    // 🔍 Viser brugerens detaljer i et modal-vindue
    private void VisDetaljer(UserModel bruger) => valgtBruger = bruger;

    // ❌ Lukker modal-vinduet ved at nulstille valgt bruger
    private void LukDetaljer() => valgtBruger = null;

    private async Task SletBrugerAsync()
    {
        // ✅ Tjek først om der er valgt en bruger
        if (valgtBruger != null)
        {
            // 🗑️ Send HTTP DELETE-anmodning til API'et for at slette brugeren
            var response = await Http.DeleteAsync($"api/users/{valgtBruger.Id}");

            // ✅ Hvis sletningen lykkes (200 OK), fjern brugeren fra listen og luk modal
            if (response.IsSuccessStatusCode)
            {
                brugere.Remove(valgtBruger); // Fjern fra lokal liste så UI opdateres
                valgtBruger = null;          // Luk modalvinduet
            }
        }
    }


    // 📄 Navigér til siden med delmål for en specifik elevplan
    private void SeElevplan(int elevplanId) => NavManager.NavigateTo($"/delmaal/{elevplanId}");

    // 🖼️ Generér URL til brugerens profilbillede baseret på deres ID
    private string GetImageUrl(int id) => $"https://localhost:7013/uploads/{id}.jpg";

    // 🎨 Returnér CSS-klasse baseret på brugerens rolle, så der kan vises farvekoder i UI'et
    private string GetRoleClass(string? role) => role?.ToLower() switch
    {
        "admin" => "role-admin",   // Bliver fx farvet blå i CSS
        "elev" => "role-elev",     // Fx grøn
        "kok" => "role-kok",       // Fx rød
        "hr" => "role-hr",         // Fx gul
        _ => "role-ukendt"         // Ukendt rolle – fallback CSS-klasse
    };
    // 📅 Returnerer skoleperiode for en elev – ellers "Ikke tilgængelig"
    private string HentSkoleperiode(UserModel bruger)
    {
        // Tjek at det er en elev, at der findes en elevplan, og at vi har hentet den
        if (bruger.Role?.ToLower() == "elev" &&
            bruger.ElevplanId.HasValue &&
            elevplaner.TryGetValue(bruger.ElevplanId.Value, out var plan))
        {
            // Hvis feltet er tomt eller null, returnér "Ikke angivet", ellers returnér periode
            return string.IsNullOrWhiteSpace(plan.Skoleperiode) ? "Ikke angivet" : plan.Skoleperiode;
        }

        return "Ikke tilgængelig";
    }

    // 📘 Returnerer skoleforløb for en elev – ellers "Ikke tilgængelig"
    private string HentSkoleforloeb(UserModel bruger)
    {
        if (bruger.Role?.ToLower() == "elev" &&
            bruger.ElevplanId.HasValue &&
            elevplaner.TryGetValue(bruger.ElevplanId.Value, out var plan))
        {
            return string.IsNullOrWhiteSpace(plan.SkoleForløb) ? "Ikke angivet" : plan.SkoleForløb;
        }

        return "Ikke tilgængelig";
    }




}
