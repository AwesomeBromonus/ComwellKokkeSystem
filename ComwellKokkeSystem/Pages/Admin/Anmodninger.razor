@page "/opretuser"
@layout AdminLayout
@inject IAuthService AuthService
@inject NavigationManager NavManager
@using Modeller

@code {
    protected override void OnInitialized()
    {
        Title = "👤 Opret ny bruger";
        Subtitle = "Udfyld formularen for at oprette en ny bruger i systemet.";
    }

    private UserModel newUser = new()
        {
            StartDato = DateTime.Today,
            SlutDato = null
        };

    private string message = "";
    private bool registerSuccess = false;

    private List<Hoteller> comwellHoteller = new()
    {
        new Hoteller { Id = 1, Navn = " Aarhus" },
        new Hoteller { Id = 2, Navn = "Borupgaard" },
        new Hoteller { Id = 3, Navn = "Bygholm Park" },
        new Hoteller { Id = 4, Navn = "Centralværkstedet" },
        new Hoteller { Id = 5, Navn = "Copenhagen Portside" },
        new Hoteller { Id = 6, Navn = "H.C. Andersen Odense" },
        new Hoteller { Id = 7, Navn = "Holte" },
        new Hoteller { Id = 8, Navn = "Hvide Hus Aalborg" },
        new Hoteller { Id = 9, Navn = "Kellers Park" },
        new Hoteller { Id = 10, Navn = "Klarskovgaard" },
        new Hoteller { Id = 11, Navn = "Kolding" },
        new Hoteller { Id = 12, Navn = "Kongebrogaarden" },
        new Hoteller { Id = 13, Navn = "Køge Strand" },
        new Hoteller { Id = 14, Navn = "Middelfart" },
        new Hoteller { Id = 15, Navn = "Rebild Bakker" },
        new Hoteller { Id = 16, Navn = "Roskilde" },
        new Hoteller { Id = 17, Navn = "Sorø" }
    };

    private async Task HandleRegister()
    {
        var success = await AuthService.Register(newUser);
        registerSuccess = success;

        if (success)
        {
            message = "Bruger oprettet!";
            await Task.Delay(1500);
            NavManager.NavigateTo("/administrator");
        }
        else
        {
            message = "Noget gik galt – brugeren blev ikke oprettet.";
        }
    }

    private void OnHotelChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id))
        {
            var valgtHotel = comwellHoteller.FirstOrDefault(h => h.Id == id);
            if (valgtHotel != null)
            {
                newUser.HotelId = valgtHotel.Id;
                newUser.HotelNavn = valgtHotel.Navn;
            }
        }
    }
}

<EditForm Model="@newUser" OnValidSubmit="HandleRegister">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="card shadow-sm border-0 p-4 rounded-4 bg-white">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-group">
                <label>Brugernavn</label>
                <InputText class="form-control rounded-pill" @bind-Value="newUser.Username" />
            </div>

            <div class="form-group">
                <label>Adgangskode</label>
                <InputText type="password" class="form-control rounded-pill" @bind-Value="newUser.Password" />
            </div>

            <div class="form-group">
                <label>Navn</label>
                <InputText class="form-control rounded-pill" @bind-Value="newUser.Navn" />
            </div>

            <div class="form-group">
                <label>Email</label>
                <InputText class="form-control rounded-pill" @bind-Value="newUser.Email" />
            </div>

            <div class="form-group">
                <label>Telefonnummer</label>
                <InputText class="form-control rounded-pill" @bind-Value="newUser.Tlf" />
            </div>

            <div class="form-group">
                <label>Adresse</label>
                <InputText class="form-control rounded-pill" @bind-Value="newUser.Adresse" />
            </div>

            <div class="form-group">
                <label>Startdato</label>
                <InputDate class="form-control rounded-pill" @bind-Value="newUser.StartDato" />
            </div>

            <div class="form-group">
                <label>Slutdato (valgfri)</label>
                <InputDate class="form-control rounded-pill" @bind-Value="newUser.SlutDato" />
            </div>

            <div class="form-group">
                <label>Hotel</label>
                <select class="form-control rounded-pill" @onchange="OnHotelChanged">
                    <option value="">Vælg hotel</option>
                    @foreach (var hotel in comwellHoteller)
                    {
                        <option value="@hotel.Id">@hotel.Navn</option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label>Rolle</label>
                <InputSelect class="form-control rounded-pill" @bind-Value="newUser.Role">
                    <option value="elev">Elev</option>
                    <option value="kok">Kok</option>
                    <option value="admin">Admin</option>
                </InputSelect>
            </div>
        </div>

        <button type="submit" class="btn btn-primary mt-4 w-100 fw-bold rounded-pill">➕ Opret Bruger</button>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="alert @(registerSuccess ? "alert-success" : "alert-danger") mt-3">@message</div>
        }
    </div>
</EditForm>
