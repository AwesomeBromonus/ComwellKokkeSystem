@page "/anmodninger"

@using Modeller
@using ComwellKokkeSystem.Service
@inject IAnmodningService AnmodningService
@inject IDelmaalService DelmaalService
@inject IUserStateService UserState
@inject NavigationManager Nav
@inject IUnderdelmaalService UnderdelmaalService
@inject IUserService UserService

<link href="css/Anmodninger.css" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet" />

<h3 class="anmodning-overskrift">📩 Indkomne Delmålsanmodninger</h3>
<br />

@* Tjekker først om brugeren er logget ind *@
@if (!UserState.IsLoggedIn)
{
    <div class="alert alert-danger">Du skal være logget ind for at se denne side.</div>
}
@* Tjekker om brugeren har den nødvendige rolle (admin eller kok) *@
else if (!UserState.IsInRole("admin") && !UserState.IsInRole("kok"))
{
    <div class="alert alert-warning">Denne side er kun for kokke og administratorer.</div>
}
@* Hvis anmodninger endnu ikke er hentet, vis loading *@
else if (anmodninger == null)
{
    <p>⏳ Indlæser anmodninger...</p>
}
@* Hvis der ikke findes anmodninger, vis besked *@
else if (!anmodninger.Any())
{
    <div class="alert alert-info">Ingen afventende anmodninger.</div>
}
@* Ellers vis alle anmodninger i et overskueligt layout *@
else
{
    <ul class="list-group">
        <div class="anmodning-container">
            @foreach (var a in anmodninger)
            {
                <div class="anmodning-kort">
                    @* Vis beskrivelse af delmål eller underdelmål hvis tilgængeligt *@
                    @if (a.DelmaalId != null && delmaalMap.ContainsKey(a.DelmaalId.Value))
                    {
                        <strong>Delmål: </strong> @delmaalMap[a.DelmaalId.Value].Beskrivelse <br />
                    }
                    else if (a.UnderdelmaalId != null && underdelmaalMap.ContainsKey(a.UnderdelmaalId.Value))
                    {
                        <strong>Underdelmål: </strong> @underdelmaalMap[a.UnderdelmaalId.Value].Beskrivelse <br />
                    }

                    <strong>Ønsket status: </strong> @a.ØnsketStatus<br />
                    <strong>Anmodet af: </strong> @brugerMap[a.ElevId].Navn<br />

                    @* Knapper til at acceptere eller afvise anmodningen *@
                    <div class="mt-2 d-flex gap-2">
                        <button class="btn btn-sm btn-success" @onclick="() => BehandlAnmodning(a.Id, true)">✅ Accepter</button>
                        <button class="btn btn-sm btn-danger" @onclick="() => BehandlAnmodning(a.Id, false)">❌ Afvis</button>
                    </div>
                </div>
            }
        </div>
    </ul>
}

<br />
<h3 class="anmodning-overskrift">⏳ Delmål med deadline inden for 14 dage</h3>

@* Vis delmål med kommende deadline eller info om ingen deadlines *@
@if (delmaalMedDeadline14Dage == null)
{
    <p>⏳ Indlæser delmål med snarlig deadline...</p>
}
else if (!delmaalMedDeadline14Dage.Any())
{
    <p>❕ Ingen deadlines tilgængelig.</p>
}
else
{
    <ul class="list-group">
        @foreach (var d in delmaalMedDeadline14Dage)
        {
            var elevNavn = eleverMedDeadline.FirstOrDefault(e => e.Id == d.ElevId)?.Navn ?? "Ukendt";

            <li class="list-group-item">
                <strong>Elev:</strong> @elevNavn <br />
                <strong>Beskrivelse:</strong> @d.Beskrivelse <br />
                <strong>Deadline:</strong> @d.Deadline.ToString("dd-MM-yyyy") <br />
                <strong>Status:</strong> @d.Status
            </li>
        }
    </ul>
}

@code {
    private List<Anmodning>? anmodninger;                                // Liste af indkomne anmodninger til modtageren
    private Dictionary<int, Delmål> delmaalMap = new();                  // Map over Delmål for hurtig opslag på id
    private Dictionary<int, Underdelmaal> underdelmaalMap = new();       // Map over Underdelmål for hurtig opslag
    private Dictionary<int, UserModel> brugerMap = new();                // Map over brugere (elever) for at vise navne

    private List<Delmål> delmaalMedDeadline14Dage = new();               // Delmål med deadline inden for 14 dage
    private List<UserModel> eleverMedDeadline = new();                   // Elever der har delmål med snarlig deadline

    // Når siden initialiseres, hentes alle nødvendige data asynkront
    protected override async Task OnInitializedAsync()
    {
        if (UserState.Id == null)
        {
            // Hvis ikke logget ind, send til login side
            Nav.NavigateTo("/login");
            return;
        }

        // Hent anmodninger til den aktuelle bruger
        anmodninger = await AnmodningService.GetTilModtagerAsync(UserState.Id.Value);

        // For hver anmodning hentes relateret delmål eller underdelmål og gemmes i dictionary
        foreach (var a in anmodninger)
        {
            if (a.DelmaalId != null)
            {
                var delmaal = await DelmaalService.GetByIdAsync(a.DelmaalId.Value);
                if (delmaal != null)
                    delmaalMap[a.DelmaalId.Value] = delmaal;
            }
            else if (a.UnderdelmaalId != null)
            {
                var underdelmaal = await UnderdelmaalService.GetByIdAsync(a.UnderdelmaalId.Value);
                if (underdelmaal != null)
                    underdelmaalMap[a.UnderdelmaalId.Value] = underdelmaal;
            }

            // Hent og gem brugeroplysninger til visning (forfatter af anmodning)
            if (!brugerMap.ContainsKey(a.ElevId))
            {
                var bruger = await UserService.GetByIdAsync(a.ElevId);
                if (bruger != null)
                    brugerMap[a.ElevId] = bruger;
            }
        }

        // Hent delmål med deadline inden for 14 dage
        delmaalMedDeadline14Dage = await DelmaalService.GetDelmaalMedDeadlineIndenFor14DageAsync();

        // Find de elever, der har disse delmål med snarlig deadline
        var elevIds = delmaalMedDeadline14Dage
            .Select(d => d.ElevId)
            .Distinct()
            .ToList();

        // Hent brugerdata for disse elever
        foreach (var elevId in elevIds)
        {
            var bruger = await UserService.GetByIdAsync(elevId);
            if (bruger != null)
                eleverMedDeadline.Add(bruger);
        }
    }

    // Behandler en anmodning: accepter eller afvis den baseret på bool-flag
    private async Task BehandlAnmodning(int anmodningId, bool accepteret)
    {
        await AnmodningService.BehandlAsync(anmodningId, accepteret);

        // Opdater listen af anmodninger efter behandling
        anmodninger = await AnmodningService.GetTilModtagerAsync(UserState.Id.Value);

        // Ryd op i mappings, da anmodningerne er ændret
        delmaalMap.Clear();
        underdelmaalMap.Clear();
        brugerMap.Clear();

        // Genopbyg mappings på baggrund af nye anmodninger
        foreach (var a in anmodninger)
        {
            if (a.DelmaalId != null)
            {
                var delmaal = await DelmaalService.GetByIdAsync(a.DelmaalId.Value);
                if (delmaal != null)
                    delmaalMap[delmaal.Id] = delmaal;
            }

            if (a.UnderdelmaalId != null)
            {
                var underdelmaal = await UnderdelmaalService.GetByIdAsync(a.UnderdelmaalId.Value);
                if (underdelmaal != null)
                    underdelmaalMap[underdelmaal.Id] = underdelmaal;
            }

            if (!brugerMap.ContainsKey(a.ElevId))
            {
                var bruger = await UserService.GetByIdAsync(a.ElevId);
                if (bruger != null)
                    brugerMap[a.ElevId] = bruger;
            }
        }

        // Opdater UI for at vise ændringer
        StateHasChanged();
    }
}
