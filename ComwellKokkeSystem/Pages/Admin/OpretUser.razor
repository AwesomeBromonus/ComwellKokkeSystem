@page "/opretuser"
@inject IAuthService AuthService
@inject NavigationManager NavManager
@using Modeller

<div class="d-flex justify-content-center align-items-center" style="min-height: 100vh; background-color: #f5f5f5;">
    <div class="p-5 shadow" style="background-color: white; border-radius: 20px; width: 100%; max-width: 600px;">
        <h2 class="text-center mb-4" style="color: #003b4a;">Opret ny bruger</h2>

        <EditForm Model="@newUser" OnValidSubmit="HandleRegister">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="form-group mb-3">
                <label>Brugernavn</label>
                <InputText class="form-control rounded-pill" @bind-Value="newUser.Username" />
            </div>

            <div class="form-group mb-3">
                <label>Adgangskode</label>
                <InputText type="password" class="form-control rounded-pill" @bind-Value="newUser.Password" />
            </div>

            <div class="form-group mb-3">
                <label>Navn</label>
                <InputText class="form-control rounded-pill" @bind-Value="newUser.Navn" />
            </div>

            <div class="form-group mb-3">
                <label>Email</label>
                <InputText class="form-control rounded-pill" @bind-Value="newUser.Email" />
            </div>

            <div class="form-group mb-3">
                <label>Telefonnummer</label>
                <InputText class="form-control rounded-pill" @bind-Value="newUser.Tlf" />
            </div>

            <div class="form-group mb-3">
                <label>Adresse</label>
                <InputText class="form-control rounded-pill" @bind-Value="newUser.Adresse" />
            </div>

            <div class="form-group mb-3">
                <label>Startdato</label>
                <InputDate class="form-control rounded-pill" @bind-Value="newUser.StartDato" />
            </div>

            <div class="form-group mb-3">
                <label>Slutdato (valgfri)</label>
                <InputDate class="form-control rounded-pill" @bind-Value="newUser.SlutDato" />
            </div>

            <div class="form-group mb-3">
                <label>Hotel</label>
               <select class="form-control rounded-pill" @onchange="OnHotelChanged">
                <option value="0">Vælg hotel</option>
                <option value="1">Kongeborgh</option>
                <option value="2">Holte</option>
                </select>
            </div>

            <div class="form-group mb-4">
                <label>Rolle</label>
                <InputSelect class="form-control rounded-pill" @bind-Value="newUser.Role">
                    <option value="elev">Elev</option>
                    <option value="kok">Kok</option>
                    <option value="HR">HR</option>
                    <option value="admin">Admin</option>
                </InputSelect>
            </div>

            <button type="submit" class="btn btn-primary w-100">Opret Bruger</button>
        </EditForm>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="alert @(registerSuccess ? "alert-success" : "alert-danger") mt-3">
                @message
            </div>
        }
    </div>
</div>

@code {
        // Opretter et nyt UserModel-objekt, som formularen binder data til
        private UserModel newUser = new()
        {
            // Startdato sættes automatisk til dags dato (bruges fx til ansættelsesstart)
            StartDato = DateTime.Today,

            // Slutdato er valgfri – derfor starter den som null
            SlutDato = null
        };

        // Besked, der vises til brugeren efter forsøg på oprettelse (succes/fejl)
        private string message = "";

        // Bool der styrer om oprettelsen lykkedes eller ej – bruges til visuel feedback
        private bool registerSuccess = false;

    // Håndterer indsendelsen af formularen
    private async Task HandleRegister()
    {
        // Forsøger at registrere brugeren via AuthService
        var success = await AuthService.Register(newUser);

        // Gemmer om oprettelsen lykkedes
        registerSuccess = success;

        if (success)
        {
            // Viser en succesbesked
            message = "Bruger oprettet!";

            // Venter lidt så brugeren kan nå at læse beskeden
            await Task.Delay(1500);

            // Navigerer tilbage til administrator-siden
            NavManager.NavigateTo("/administrator");
        }
        else
        {
            // Viser en fejlbesked hvis noget gik galt
            message = "Noget gik galt – brugeren blev ikke oprettet.";
        }
    }
    // Denne metode håndterer ændring af hotelværdien fra dropdown-menuen
    private void OnHotelChanged(ChangeEventArgs e)
    {
        // Forsøger at konvertere den valgte værdi til et heltal
        if (int.TryParse(e.Value?.ToString(), out int id))
        {
            // Gemmer ID’et på brugeren
            newUser.HotelId = id;

            // Sætter det tilsvarende hotelnavn
            newUser.HotelNavn = id switch
            {
                1 => "Kongeborgh",
                2 => "Holte",
                _ => null // Hvis ID ikke matcher noget, sættes navnet til null
            };
        }
    }
}
