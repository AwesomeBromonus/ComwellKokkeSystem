@page "/rapportside"
@using Modeller
@using ComwellKokkeSystem.Service
@using System
@inject IGenereRapportService RapportService
@inject IAuthService AuthService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject IElevplanService ElevplanService

<h3>HR Rapport</h3>
@if (!_isAuthorized)
{
    <p>Adgang nægtet. Kun admin, HR eller kok kan se denne side.</p>
}
else if (_praktikperioder == null || _delmål == null || _brugere == null || _elever == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <h4>Praktikperioder</h4>
    <select @onchange="ChangeYear">
        <option value="2025">2025</option>
        <option value="2026">2026</option>
        <option value="2027">2027</option>
        <option value="2028">2028</option>
        <option value="2029">2029</option>
        <option value="2030">2030</option>
    </select>

    <div class="mt-4">
        <button class="btn btn-primary me-2" @onclick="ExportToCsv">Eksporter til CSV</button>
        <button class="btn btn-success me-2" @onclick="ExportToExcel">Eksporter til Excel</button>

        <h4 class="mt-4">Elevprogression</h4>
        @if (_elever.Any())
        {
            <div class="mb-3">
                <label for="elevSelect" class="form-label">Vælg elev:</label>
                <select id="elevSelect" class="form-select" @bind="_selectedElevId">
                    <option value="0">-- Vælg elev --</option>
                    @foreach (var elev in _elever)
                    {
                        <option value="@elev.Id">@elev.Navn</option>
                    }
                </select>
            </div>

            @if (_selectedElevId > 0)
            {
                <ElevProgression ElevId="selectedElevId" />
            }
        }
        else
        {
            <p>Ingen elever fundet.</p>
        }
    </div>

    <table class="table mt-3">
        <thead>
            <tr>
                <th>Navn</th>
                <th>Start Dato</th>
                <th>Slut Dato</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var periode in _praktikperioder)
            {
                <tr>
                    <td>@periode.Navn</td>
                    <td>@(periode.StartDato.ToString("dd/MM/yyyy") ?? "Ingen dato")</td>
                    <td>@(periode.SlutDato.ToString("dd/MM/yyyy") ?? "Ingen dato")</td>
                </tr>
            }
        </tbody>
    </table>

    <h4>Delmål Deadlines</h4>
    <table class="table">
        <thead>
            <tr>
                <th>Elev</th>
                <th>Beskrivelse</th>
                <th>Deadline</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var dm in _delmål)
            {
                <tr>
                    <td>@dm.ElevNavn</td>
                    <td>@dm.Beskrivelse</td>
                    <td>@(dm.Deadline.ToString("dd/MM/yyyy") ?? "Ingen dato")</td>
                </tr>
            }
        </tbody>
    </table>

    <h4>Nye Brugere</h4>
    <table class="table">
        <thead>
            <tr>
                <th>Navn</th>
                <th>Start Dato</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var bruger in _brugere)
            {
                <tr>
                    <td>@bruger.Navn</td>
                    <td>@(bruger.StartDato.ToString("dd/MM/yyyy") ?? "Ingen dato")</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<Praktikperiode> _praktikperioder = new();
    private List<DelmålDTO> _delmål = new(); // Ændret til DelmålDTO
    private List<UserModel> _brugere = new();
    private List<UserModel> _elever = new();
    private int _selectedYear = 2025;
    private int _selectedElevId = 0;
    private bool _isAuthorized = false;

    protected override async Task OnInitializedAsync()
    {
        var role = await AuthService.GetCurrentUserRoleAsync();
        Console.WriteLine($"Brugerrolle: {role}");
        _isAuthorized = !string.IsNullOrEmpty(role) &&
                       (role.Equals("Admin", StringComparison.OrdinalIgnoreCase) ||
                        role.Equals("HR", StringComparison.OrdinalIgnoreCase) ||
                        role.Equals("kok", StringComparison.OrdinalIgnoreCase));
        if (!_isAuthorized)
        {
            NavigationManager.NavigateTo("/access-denied");
            return;
        }

        await LoadData();
    }

    private async Task LoadData()
    {
        _praktikperioder = await RapportService.GetPraktikPerioderAsync(_selectedYear) ?? new List<Praktikperiode>();
        _delmål = await RapportService.GetDelmålAsync(_selectedYear) ?? new List<DelmålDTO>(); // Ændret til DelmålDTO
        _brugere = await RapportService.GetBrugereAsync(_selectedYear) ?? new List<UserModel>();
        _elever = await RapportService.GetEleverAsync(_selectedYear) ?? new List<UserModel>();
    }

    private async Task ChangeYear(ChangeEventArgs e)
    {
        if (e.Value != null)
        {
            _selectedYear = int.Parse(e.Value.ToString());
            await LoadData();
        }
    }

    private async Task ExportToCsv()
    {
        try
        {
            var fileContent = await RapportService.ExportToCsvAsync(_selectedYear);
            if (fileContent.Length > 0)
            {
                await DownloadFile("rapport.csv", "text/csv", fileContent);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fejl ved eksport til CSV: {ex.Message}");
        }
    }

    private async Task ExportToExcel()
    {
        try
        {
            var fileContent = await RapportService.ExportToExcelAsync(_selectedYear);
            if (fileContent.Length > 0)
            {
                await DownloadFile("rapport.xlsx", "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", fileContent);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Fejl ved eksport til Excel: {ex.Message}");
        }
    }

    private async Task DownloadFile(string fileName, string contentType, byte[] content)
    {
        await JSRuntime.InvokeVoidAsync("BlazorDownloadFile", fileName, contentType, content);
    }
}