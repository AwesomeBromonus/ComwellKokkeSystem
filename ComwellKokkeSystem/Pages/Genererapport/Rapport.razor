@page "/rapportside"
@using ComwellKokkeSystem.Service
@inject IRapportService RapportService
@inject IUserService UserService
@inject IDelmaalService DelmaalService
@inject IUnderdelmaalService UnderdelmaalService
@inject IPraktikperiodeService praktikperiodeService
@inject IJSRuntime JS
@using Modeller

<h3 class="mb-4">📊 Elevrapport</h3>

@if (brugere == null || delmaalListe == null)
{
    <p>⏳ Indlæser data...</p>
}
else
{
    <button class="btn btn-success mb-3" @onclick="EksporterExcel">📥 Eksportér til Excel</button>

    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Elevnavn</th>
                <th>Email</th>
                <th>Hotel</th>
                <th>Delmål</th>
                <th>Delmål Deadline</th>
                <th>Delmål Status</th>
                <th>Underdelmål</th>
                <th>Underdelmål Deadline</th>
                <th>Underdelmål Status</th>
                <th>Praktikperiode</th>
                <th>Praktikperiode Status</th>
            </tr>
        </thead>

        <tbody>
            @foreach (var bruger in brugere)
            {
                var elevensPerioder = praktikperioder
                .Where(p => p.ElevplanId == bruger.ElevplanId)
                .Select(p => p.Id);

                var elevensDelmaal = delmaalListe
                .Where(d => elevensPerioder.Contains(d.PraktikperiodeId));


                foreach (var d in elevensDelmaal)
                {
                    var underdelmaal = underdelmaalMap.ContainsKey(d.Id) ? underdelmaalMap[d.Id] : new List<Underdelmaal>();
                    var periode = praktikperioder.FirstOrDefault(p => p.Id == d.PraktikperiodeId);

                    if (underdelmaal.Any())
                    {
                        foreach (var u in underdelmaal)
                        {
                            <tr>
                                <td>@bruger.Navn</td>
                                <td>@bruger.Email</td>
                                <td>@bruger.HotelNavn</td>
                                <td>@d.Beskrivelse</td>
                                <td>@d.Deadline.ToShortDateString()</td>
                                <td>@d.Status</td>
                                <td>@u.Beskrivelse</td>
                                <td>@u.Deadline.ToShortDateString()</td>
                                <td>@u.Status</td>
                                <td>@periode?.Navn</td>
                                <td>@periode?.Status</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td>@bruger.Navn</td>
                            <td>@bruger.Email</td>
                            <td>@bruger.HotelNavn</td>
                            <td>@d.Beskrivelse</td>
                            <td>@d.Deadline.ToShortDateString()</td>
                            <td>@d.Status</td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                            <td>@periode?.Navn</td>
                            <td>@periode?.Status</td>
                        </tr>
                    }
                }
            }
        </tbody>
    </table>
}

@code {
    private List<UserModel>? brugere;
    private List<Delmål>? delmaalListe;
    private List<Praktikperiode> praktikperioder = new();
    private Dictionary<int, List<Underdelmaal>> underdelmaalMap = new();

    protected override async Task OnInitializedAsync()
    {
        brugere = (await UserService.GetAllAsync()).Where(u => u.Role.ToLower() == "elev").ToList();
        delmaalListe = await DelmaalService.GetAllAsync();
        praktikperioder = await praktikperiodeService.GetAllAsync();

        // Hent alle underdelmål og læg dem i dictionary
        foreach (var d in delmaalListe)
        {
            var under = await UnderdelmaalService.GetByDelmaalIdAsync(d.Id);
            underdelmaalMap[d.Id] = under ?? new();
        }
    }

    private async Task EksporterExcel()
    {
        var data = await RapportService.HentExcelRapportAsync();
        var filnavn = $"Elevrapport_{DateTime.Now:yyyyMMddHHmmss}.xlsx";

        using var streamRef = new DotNetStreamReference(new MemoryStream(data));
        await JS.InvokeVoidAsync("downloadFileFromStream", filnavn, streamRef);
    }
}
