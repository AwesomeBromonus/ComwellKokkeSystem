@page "/laering"
@using Microsoft.AspNetCore.Components.Forms
@using Modeller
@inject ILæringService LæringService  // Tjeneste til at hente og uploade læringsmaterialer
@inject IUserStateService UserStateService
      

<h3 class="text-2xl font-semibold mb-4">📚 Læringsmaterialer</h3>

@if (UserStateService.CurrentUser?.Role == "admin" || UserStateService.CurrentUser?.Role == "kok")
{
    <button @onclick="ToggleForm"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition mb-4">
        @(VisForm ? "Annuller" : "➕ Tilføj materiale")
    </button>
}

@if (VisForm && (UserStateService.CurrentUser?.Role == "admin" || UserStateService.CurrentUser?.Role == "kok"))
{
    <!-- Formular til oprettelse af nyt læringsmateriale -->
    <div class="bg-gray-100 p-4 rounded shadow mb-4">
        <form onsubmit="return false;">
            <div class="mb-2">
                <label class="block mb-1 font-medium">Titel</label>
                <InputText class="w-full p-2 rounded border" @bind-Value="nyLæring.Titel" />
            </div>

            <div class="mb-2">
                <label class="block mb-1 font-medium">Beskrivelse</label>
                <InputTextArea class="w-full p-2 rounded border" @bind-Value="nyLæring.Beskrivelse" />
            </div>

            <div class="mb-2">
                <label class="block mb-1 font-medium">Fil</label>
                <InputFile OnChange="HandleFileChange" accept=".pdf,.jpg,.jpeg,.png,.mp4" />
            </div>

            <button type="button" @onclick="HandleUpload"
                    class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 mt-2">
                Upload
            </button>
        </form>
    </div>
}

@if (Materialer.Count > 0)
{
    <!-- Viser eksisterende materialer -->
    <div class="grid gap-4">
        @foreach (var item in Materialer)
        {
            <div class="p-4 border rounded bg-white shadow-sm">
                <h4 class="font-bold">@item.Titel</h4>
                <p class="text-sm text-gray-600 mb-2">@item.Beskrivelse</p>
                <div>
                    <span>@GetIkon(item.Filtype)</span>
                    <a href="https://localhost:7013/api/laering/fil/@item.Id"
                       download="@item.FilNavn"
                       class="text-blue-600 underline ml-1">
                        @item.FilNavn
                    </a>
                </div>
            </div>
        }
    </div>
}
else
{
    <p class="text-gray-600">Ingen materialer fundet.</p>
}

@code {
    // Liste over alle læringsmaterialer hentet fra tjenesten
    private List<Modeller.Læring> Materialer = new();

    // Det læringsobjekt som brugeren er ved at oprette
    private Modeller.Læring nyLæring = new();

    // Den valgte fil fra InputFile
    private IBrowserFile? valgtFil;

    // Bruges til at vise/skjule oprettelsesformular
    private bool VisForm = false;

    /// <summary>
    /// Henter læringsmaterialer ved komponentinitialisering
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        Materialer = await LæringService.HentAlleAsync();
    }

    /// <summary>
    /// Skifter mellem at vise og skjule formular til oprettelse
    /// </summary>
    private void ToggleForm() => VisForm = !VisForm;

    /// <summary>
    /// Håndterer filvalg fra InputFile-komponenten
    /// </summary>
    /// <param name="e">Event data med valgt fil</param>
    private void HandleFileChange(InputFileChangeEventArgs e)
    {
        valgtFil = e.File;
    }

    /// <summary>
    /// Uploader det nye læringsmateriale samt tilhørende fil.
    /// Hvis upload lykkes, nulstilles formularen og materialer hentes på ny.
    /// </summary>
    private async Task HandleUpload()
    {
        if (valgtFil == null) return;

        var success = await LæringService.UploadAsync(nyLæring, valgtFil);

        if (success)
        {
            nyLæring = new Modeller.Læring();               // Nulstil formular
            valgtFil = null;
            VisForm = false;
            Materialer = await LæringService.HentAlleAsync();  // Genindlæs materialer
        }
    }

    /// <summary>
    /// Returnerer emoji-ikon afhængig af filtype
    /// </summary>
    /// <param name="type">Filtype som f.eks. pdf, jpg, mp4</param>
    /// <returns>En emoji repræsentation af filtypen</returns>
    private string GetIkon(string type) => type.ToLower() switch
    {
        "pdf" => "📄",
        "mp4" => "🎥",
        "mp3" => "🎵",
        "jpg" or "jpeg" or "png" => "🖼️",
        _ => "📁"
    };
}
